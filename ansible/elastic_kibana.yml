---
- name: Install Elasticsearch on elasticsearch host
  hosts: elasticsearch
  become: yes
  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Установка elasticsearch
      apt:
        deb: "https://mirror.yandex.ru/mirrors/elastic/8/pool/main/e/elasticsearch/elasticsearch-8.18.2-amd64.deb"

    - name: Configure Elasticsearch
      block:
        - name: cluster master node
          lineinfile:
            path: /etc/elasticsearch/elasticsearch.yml
            regexp: '^cluster\.initial_master_nodes: \["elasticsearch"\]$'
            line: 'cluster.initial_master_nodes: ["{{ ansible_default_ipv4.address }}"]'

        - name: node name
          lineinfile:
            path: /etc/elasticsearch/elasticsearch.yml
            line: 'node.name: node-1'
            create: yes

        - name: host name
          lineinfile:
            path: /etc/elasticsearch/elasticsearch.yml
            line: 'network.host: 0.0.0.0'
            create: yes

        - name: host port
          lineinfile:
            path: /etc/elasticsearch/elasticsearch.yml
            line: 'http.port: 9200'
            create: yes

    - name: daemon_reload
      systemd:
        daemon_reload: true

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch
        enabled: yes
        state: started
    
- name: Install Kibana on kibana host
  hosts: kibana
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
    
    - name: Установка Kibana
      apt:
        deb: "https://mirror.yandex.ru/mirrors/elastic/8/pool/main/k/kibana/kibana-8.18.2-amd64.deb"

    - name: Configure Kibana
      lineinfile:
        path: /etc/kibana/kibana.yml
        line: 'server.host: "0.0.0.0"'
        create: yes

    - name: Enable and start Kibana service
      systemd:
        name: kibana
        enabled: yes
        state: started

